# üìã Gu√≠a de Onboarding para IA Programadora
## Proyecto: ABD RAG Platform (Next.js + MongoDB + RAG Enterprise)

**Versi√≥n:** 1.0  
**Tiempo estimado de lectura:** 15-20 minutos  
**Prioridad:** CR√çTICA - Leer en orden

---

## üéØ FASE 1: Contexto Global (5 minutos)

### 1.1 Archivos de Entrada Obligatorios
Leer primero estos 3 archivos para entender el "qu√©" y el "porqu√©":

1. **`/package.json`**
   - Identificar dependencias cr√≠ticas: `next-auth`, `mongodb`, `zod`, `framer-motion`, `@radix-ui/*`
   - Notar scripts disponibles (`dev`, `build`, `lint`)

2. **`/next.config.js` (o .mjs)`**
   - Verificar configuraci√≥n de im√°genes (Cloudinary)
   - Variables de entorno expuestas al cliente
   - Rewrites/redirects si existen

3. **`/src/app/layout.tsx`**
   - Estructura de providers (ThemeProvider, SessionProvider, NextIntlClientProvider)
   - Tipograf√≠a (Geist Sans/Mono)
   - Metadatos y SEO base

### 1.2 Entender el Prop√≥sito
Este NO es un CRUD simple. Es una **plataforma de conocimiento t√©cnico inteligente** para industrias reguladas (ascensores, equipos industriales). Cada l√≠nea de c√≥digo debe considerar:
- Multi-tenancy estricto (aislamiento de datos por organizaci√≥n)
- Compliance normativo (trazabilidad completa, GDPR)
- Procesamiento de PDFs con IA (RAG)

---

## üèóÔ∏è FASE 2: Arquitectura Base (5 minutos)

### 2.1 Sistema de Autenticaci√≥n y Seguridad
**Orden de lectura:**
1. **`/src/lib/auth.config.ts`** ‚Üí Configuraci√≥n de NextAuth (providers, callbacks)
2. **`/src/lib/auth.ts`** ‚Üí Helpers de autorizaci√≥n (`requireSuperAdmin`, `requireAuth`)
3. **`/src/middleware.ts`** ‚Üí Protecci√≥n de rutas, redirecciones por rol

**Aspectos cr√≠ticos a notar:**
- Roles jer√°rquicos: `SUPER_ADMIN` > `ADMIN` > `ENGINEERING` > `TECHNICAL`
- El `tenantId` viene en la sesi√≥n y DEBE filtrar TODAS las queries
- Middleware "Fail Closed": Si falla, deniega acceso (no permite bypass)

### 2.2 Conexi√≥n a Datos
**Orden de lectura:**
1. **`/src/lib/db.ts`** ‚Üí Conexi√≥n a MongoDB (AuthDB + Business DB)
2. **`/src/lib/db-tenant.ts`** ‚Üí `getTenantCollection()` - **FUNCI√ìN CR√çTICA**
3. **`/src/lib/schemas.ts`** ‚Üí Esquemas Zod base (User, Tenant, etc.)

**Patr√≥n arquitect√≥nico clave:**
```typescript
// SIEMPRE usar getTenantCollection en lugar de db.collection directo
const collection = await getTenantCollection('pedidos', session);
// Esto autom√°ticamente inyecta el filtro { tenantId: session.user.tenantId }
2.3 Manejo de Errores y Logging
Leer:
/src/lib/errors.ts ‚Üí Clases AppError, ValidationError, NotFoundError
/src/lib/logger.ts ‚Üí logEvento() - Toda operaci√≥n debe loguearse
Regla de Oro:
Todo endpoint DEBE envolver su l√≥gica en try-catch y usar handleApiError() o logEvento(). El correlationId es obligatorio para trazabilidad.
üß† FASE 3: Sistemas Core (8 minutos)
3.1 Entity Engine (El "Cerebro")
Archivos esenciales:
/src/core/engine/EntityEngine.ts (o donde est√© definido)
/src/app/api/core/entities/[type]/route.ts ‚Üí API universal
/src/components/shared/DynamicFormModal.tsx ‚Üí UI generada din√°mica
Concepto a entender:
Las entidades (pedidos, equipos, clientes) NO son clases est√°ticas. Se definen en una ontolog√≠a (configuraci√≥n) y el sistema genera autom√°ticamente:
Formularios
Tablas
Validaciones
APIs
Campos especiales a reconocer:
searchable: true ‚Üí Se indexa para b√∫squeda
encrypted: true ‚Üí Se cifra con SecurityService
type: 'relation' ‚Üí Referencia a otra entidad
3.2 Workflow Engine
Archivos esenciales:
/src/lib/workflow-service.ts (o similar)
/src/app/api/admin/workflow-definitions/route.ts
/src/components/workflow/WorkflowStatusBar.tsx
Concepto clave:
M√°quina de estados finita (FSM) donde:
Los estados son configurables por tenant (colores, nombres)
Las transiciones requieren permisos (allowedRoles)
Se puede requerir firma digital (requiresSignature: true)
El historial es append-only (nunca se borra)
3.3 Sistema RAG (IA/Vectorial)
Archivos esenciales:
/src/lib/rag-service.ts ‚Üí hybridSearch(), generaci√≥n de embeddings
/src/app/api/admin/ingest/route.ts ‚Üí Procesamiento de PDFs
/src/services/ingest-service.ts ‚Üí L√≥gica de chunking
Flujo de datos:
Copy
PDF Upload ‚Üí Cloudinary ‚Üí Text Extraction ‚Üí Chunking ‚Üí Embeddings ‚Üí MongoDB (Atlas Vector Search)
                                                    ‚Üì
Query Usuario ‚Üí Embedding ‚Üí Vector Search + Text Search ‚Üí Re-rank (si existe) ‚Üí Prompt Gemini ‚Üí Respuesta
Colecciones importantes:
knowledge_assets ‚Üí Metadatos de documentos
document_chunks ‚Üí Fragmentos vectoriales
rag_evaluations ‚Üí M√©tricas de calidad (faithfulness, relevance)
üé® FASE 4: Patrones de Frontend (5 minutos)
4.1 Hooks Gen√©ricos (NO usar useEffect directo para data fetching)
Leer:
/src/hooks/useApiList.ts ‚Üí Para listados con paginaci√≥n
/src/hooks/useApiItem.ts ‚Üí Para detalle de entidades
/src/hooks/useApiMutation.ts ‚Üí Para POST/PUT/DELETE
/src/hooks/useFormModal.ts ‚Üí Gesti√≥n de modales CRUD
Ejemplo de uso correcto:
TypeScript
Copy
// ‚úÖ BIEN
const { data, isLoading, refresh } = useApiList<Entity>({
  endpoint: entity.api.list,
  dataKey: 'entities'
});

// ‚ùå MAL - No hacer fetch directo en useEffect
useEffect(() => {
  fetch('/api/entities').then(...) 
}, []);
4.2 Componentes UI Base
Leer:
/src/components/ui/page-container.tsx ‚Üí Layout de p√°ginas
/src/components/ui/data-table.tsx ‚Üí Tablas din√°micas
/src/components/ui/content-card.tsx ‚Üí Cards consistentes
Dise√±o visual:
Usar Tailwind con clases utilitarias
Paleta: Slate (grises) + Teal (acento) + colores sem√°nticos (Emerald, Amber, Rose)
Dark mode soportado v√≠a dark: prefix
Tipograf√≠a: Geist Sans (UI), Geist Mono (datos/c√≥digo)
4.3 Internacionalizaci√≥n (i18n)
Usar next-intl
Textos hardcodeados en espa√±ol en algunas partes, ingl√©s en otras ‚Üí Mantener consistencia del contexto
Si el archivo est√° en /app/(authenticated)/(admin)/, probablemente sea espa√±ol
Si es c√≥digo core/utils, ingl√©s
‚ö†Ô∏è FASE 5: Reglas de Negocio Cr√≠ticas (OBLIGATORIO)
5.1 Seguridad y Multi-tenancy (VIOLAR = BUG CR√çTICO)
REGLA #1: Aislamiento de Tenant
TypeScript
Copy
// SIEMPRE filtrar por tenantId en queries
const filter = userRole === 'SUPER_ADMIN' 
  ? {} 
  : { tenantId: session.user.tenantId };

// NUNCA devolver datos de otro tenant
REGLA #2: Validaci√≥n Zod ANTES de procesar
Todo input de usuario (body, query params, formData) debe pasar por Zod antes de tocar la DB.
REGLA #3: Campos Cifrados
Si un campo tiene encrypted: true en la ontolog√≠a:
Usar SecurityService.encrypt() al guardar
Usar SecurityService.decrypt() al leer
Nunca loguear el valor descifrado
REGLA #4: Auditor√≠a
Toda operaci√≥n de escritura debe loguearse:
TypeScript
Copy
await logEvento({
  level: 'INFO' | 'WARN' | 'ERROR',
  source: 'NOMBRE_MODULO',
  action: 'NOMBRE_ACCION',
  message: 'Descripci√≥n',
  correlationId,
  details: { /* datos no sensibles */ }
});
5.2 Performance (SLAs)
El c√≥digo tiene SLAs definidos:
Listados: < 200ms
Operaciones de escritura: < 1000ms
Ingesta de PDFs: < 20000ms (async si es posible)
Si una operaci√≥n supera el SLA, loguear WARN:
TypeScript
Copy
if (duration > 1000) {
  await logEvento({
    level: 'WARN',
    source: 'API_XXX',
    action: 'PERFORMANCE_SLA_VIOLATION',
    message: `Operaci√≥n lenta: ${duration}ms`,
    details: { durationMs: duration }
  });
}
5.3 Manejo de Archivos
Subida: Siempre a Cloudinary, nunca al filesystem local
URLs: Usar getPDFDownloadUrl() para generar URLs firmadas si es necesario
Soft Delete: Nunca borrar f√≠sicamente documentos de Cloudinary (compliance). Marcar como obsoleto en DB.
‚úÖ CHECKLIST: Antes de Escribir C√≥digo
Para nuevas APIs (route.ts):
[ ] ¬øEst√° el archivo en la ruta correcta (/api/[√°rea]/...)?
[ ] ¬øImporta auth() y verifica el rol adecuado?
[ ] ¬øExtrae tenantId de la sesi√≥n y filtra queries?
[ ] ¬øUsa Zod para validar inputs?
[ ] ¬øGenera correlationId con crypto.randomUUID()?
[ ] ¬øEnvuelve la l√≥gica en try-catch con handleApiError?
[ ] ¬øLoguea la operaci√≥n con logEvento?
[ ] ¬øMide tiempo de ejecuci√≥n para detectar SLA violations?
Para nuevos Componentes:
[ ] ¬øUsa useApiList/useApiItem para data fetching?
[ ] ¬øManeja estados de loading con skeletons?
[ ] ¬øUsa componentes UI base (PageContainer, ContentCard)?
[ ] ¬øImplementa optimistic updates si es mutaci√≥n?
[ ] ¬øEs responsive (mobile-first)?
Para nuevas Entidades (Entity Engine):
[ ] ¬øDefini√≥ la ontolog√≠a en el EntityEngine?
[ ] ¬øMarc√≥ campos sensibles como encrypted: true?
[ ] ¬øMarc√≥ campos buscables como searchable: true?
[ ] ¬øCre√≥ los √≠ndices MongoDB necesarios?
üìö FASE 6: Deep Dive por √Årea (Seg√∫n la Tarea)
Si vas a trabajar en Autenticaci√≥n/Autorizaci√≥n:
Revisar /src/app/api/auth/[...nextauth]/route.ts
Revisar /src/app/api/auth/invite/* (sistema de invitaciones)
Revisar /src/app/api/auth/mfa/* (autenticaci√≥n multifactor)
Nota: Los usuarios se crean en authDb (MongoDB auth), no en business DB
Si vas a trabajar en RAG/IA:
Revisar /src/lib/rag-service.ts
Revisar /src/app/api/admin/ingest/*
Revisar /src/app/api/admin/knowledge-base/*
Nota: Los chunks deben incluir tenantId y status (vigente/obsoleto)
Si vas a trabajar en Workflows:
Revisar /src/lib/workflow-service.ts
Revisar /src/lib/workflow-engine.ts
Revisar /src/app/api/cases/[id]/transition/route.ts
Nota: Las transiciones pueden requerir firma digital (campo signature)
Si vas a trabajar en Billing/Facturaci√≥n:
Revisar /src/lib/billing-service.ts
Revisar /src/lib/stripe.ts
Revisar /src/app/api/billing/*
Nota: Los planes se definen en pricing_plans collection
üîç FASE 7: Debugging y Troubleshooting
D√≥nde buscar cuando algo falla:
Error de autenticaci√≥n:
Verificar middleware.ts (matcher config)
Verificar auth.config.ts (callbacks session/jwt)
Logs en application_logs con source: 'AUTH'
Error de datos (datos no aparecen):
Verificar getTenantCollection est√° filtrando correctamente
Verificar √≠ndices en MongoDB (db.collection.getIndexes())
Verificar que el dataKey en useApiList coincida con la respuesta API
Error de RAG (respuestas malas):
Revisar rag_evaluations para ver scores de faithfulness
Verificar que los chunks tengan status: 'vigente' (no obsoleto)
Revisar logs de source: 'RAG_SERVICE'
Error de performance:
Buscar logs con action: 'PERFORMANCE_SLA_VIOLATION'
Revisar si hay N+1 queries (faltan $lookup o populate)
Verificar √≠ndices en campos de b√∫squeda frecuentes
üöÄ Comandos √ötiles para Empezar
bash
Copy
# Instalar dependencias
npm install

# Variables de entorno necesarias (.env.local)
# - MONGODB_URI (business DB)
# - MONGODB_AUTH_URI (auth DB)
# - NEXTAUTH_SECRET
# - CLOUDINARY_CLOUD_NAME, API_KEY, API_SECRET
# - GEMINI_API_KEY (o OPENAI_API_KEY)
# - STRIPE_SECRET_KEY (si trabajas en billing)

# Modo desarrollo
npm run dev

# Verificar tipos (obligatorio antes de commit)
npm run type-check

# Linting
npm run lint
üìû Escalaci√≥n
Si encuentras algo que no est√° documentado aqu√≠ o no sigue estos patrones:
Buscar archivos similares existentes y copiar el patr√≥n
Revisar /src/lib/README.md (si existe)
Consultar logs de application_logs para ver c√≥mo se comporta en producci√≥n
Recuerda: Este es un sistema enterprise de misi√≥n cr√≠tica. La consistencia y seguridad son m√°s importantes que la velocidad de desarrollo. Cuando dudes, s√© m√°s restrictivo (Fail Closed).
Fin de la Gu√≠a. Bienvenido al proyecto. üöÄ