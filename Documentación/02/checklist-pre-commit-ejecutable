# CHECKLIST PRE-COMMIT EJECUTABLE
## Validar cÃ³digo antes de Push

---

## ğŸš€ CÃ“MO USAR

1. **En tu terminal**, antes de hacer `git push`:
```bash
npm run pre-commit
```

2. **O manual**, sigue esta checklist lÃ­nea por lÃ­nea.

3. **Si algo falla**, regresa y corrige el cÃ³digo.

---

## ğŸ“ CHECKLIST DESARROLLO

### FASE 1: Linting & Formatting (Automatizado)

```bash
# ESLint - detecta issues
npm run lint
# Output esperado: "0 problems"

# TypeScript type checking
npm run type-check
# Output esperado: "0 errors"

# Prettier - formatting
npm run format
# Output esperado: "no changes needed" (si ya estÃ¡ formateado)
```

**âœ… Si pasan todos:** ContinÃºa a Fase 2.  
**âŒ Si alguno falla:** `npm run lint -- --fix && npm run format` y reintenta.

---

### FASE 2: Tests (Automatizado)

```bash
# Unit tests
npm run test:unit
# Output esperado: "All tests passed"

# Integration tests (si hay)
npm run test:integration
# Output esperado: "All tests passed"

# Coverage mÃ­nimo
npm run test:coverage
# Output esperado: > 70% coverage
```

**âœ… Si pasan todos:** ContinÃºa a Fase 3.  
**âŒ Si alguno falla:** Revisar output, aÃ±adir tests faltantes.

---

### FASE 3: Build Check (Automatizado)

```bash
# Full build (asegura que todo compila)
npm run build
# Output esperado: "Build complete" con 0 errors

# (Si hay, probablemente TypeScript strict mode)
```

**âœ… Si compila:** ContinÃºa a Fase 4.  
**âŒ Si falla:** Revisar errores de TypeScript, corregir tipos.

---

### FASE 4: Code Review Manual

Revisa los archivos que modificaste lÃ­nea por lÃ­nea. Para cada bloque:

#### REGLA #1: TypeScript Strict âœ…

```typescript
// âŒ RECHAZAR
const data: any = ...
function f(x) { ... }
let data;  // sin tipo

// âœ… ACEPTAR
const data: string = ...
function f(x: string): void { ... }
let data: string;
```

**Checklist:**
- [ ] Todas las variables tienen tipo explÃ­cito
- [ ] Todas las funciones tienen tipos en parÃ¡metros
- [ ] Todas las funciones tienen tipo de retorno
- [ ] No hay `any` en el cÃ³digo

---

#### REGLA #2: Zod Validation âœ…

Para endpoints/funciones que reciben input externo:

```typescript
// âŒ RECHAZAR - sin validaciÃ³n
export async function POST(req) {
  const file = req.formData().get('file')
  if (file.size > MAX) { ... }  // ValidaciÃ³n DESPUÃ‰S
}

// âœ… ACEPTAR - validaciÃ³n PRIMERO
export async function POST(req) {
  const validated = UploadSchema.parse(await req.formData())
  // Procesar validated (tipo-seguro)
}
```

**Checklist:**
- [ ] Â¿Recibe el cÃ³digo input externo? (form, query, body, file)
- [ ] Â¿Si sÃ­, hay Zod schema?
- [ ] Â¿Schema se llama ANTES de procesar? (.parse() en primera lÃ­nea)
- [ ] Â¿Hay error handling para schema failures?

---

#### REGLA #3: AppError âœ…

```typescript
// âŒ RECHAZAR
throw new Error("Failed")
throw "error"
throw { message: "..." }

// âœ… ACEPTAR
throw new ValidationError("Invalid input")
throw new DatabaseError("Query failed")
throw new ExternalServiceError("Gemini", "Rate limited")
```

**Checklist:**
- [ ] Â¿Hay try/catch en la funciÃ³n?
- [ ] Â¿Si sÃ­, Â¿quÃ© se hace en catch?
- [ ] Â¿Lanzas AppError o subclass?
- [ ] Â¿Nunca lanzas Error() genÃ©rico?

---

#### REGLA #4: Logging Estructurado âœ…

```typescript
// âŒ RECHAZAR
console.log("Starting analysis")
logEvento(...)  // sin await

// âœ… ACEPTAR
await logEvento({
  nivel: 'INFO',
  origen: 'API_PEDIDOS',
  accion: 'ANALIZAR_PEDIDO',
  mensaje: 'Iniciando anÃ¡lisis',
  correlacion_id,
  detalles: { file_size: file.size }
})
```

**Checklist:**
- [ ] Â¿Hay logEvento() al inicio?
- [ ] Â¿Hay await frente a logEvento?
- [ ] Â¿Hay correlacion_id?
- [ ] Â¿Hay origen y accion?
- [ ] Â¿Hay detalles relevantes?
- [ ] Â¿Si error, hay logEvento con nivel ERROR?

---

#### REGLA #5: NO Browser Storage âœ…

```typescript
// âŒ RECHAZAR EN SERVIDOR
if (typeof window !== 'undefined') {
  localStorage.getItem('token')  // AÃºn puede fallar
}

sessionStorage.setItem('data', x)
document.cookie = 'x=y'

// âœ… ACEPTAR
await getCookie('token')  // Server-side
```

**Checklist:**
- [ ] Â¿Hay `localStorage` en el cÃ³digo? â†’ RECHAZAR
- [ ] Â¿Hay `sessionStorage`? â†’ RECHAZAR
- [ ] Â¿Hay `document.cookie`? (directo) â†’ RECHAZAR
- [ ] Â¿Hay `IndexedDB`? â†’ RECHAZAR

---

#### REGLA #6: ValidaciÃ³n Cliente + Servidor âœ…

```typescript
// CLIENTE
'use client'
try {
  const validated = Schema.parse(data)
} catch (err) {
  setError(err.message)  // Feedback inmediato
  return
}
await fetch(...)

// SERVIDOR
export async function POST(req) {
  const validated = Schema.parse(await req.formData())  // Validar OTRA VEZ
  if (!validated) throw new ValidationError(...)
}
```

**Checklist:**
- [ ] Â¿Si hay formulario, valida el cliente?
- [ ] Â¿Muestra error al usuario en cliente?
- [ ] Â¿El servidor TAMBIÃ‰N valida?
- [ ] Â¿Mismo schema Zod en ambos lados?

---

#### REGLA #7: DB Operaciones AtÃ³micas âœ…

```typescript
// âŒ RECHAZAR - sin transaction
await pedidos.insertOne(data)
await usuarios.updateOne(...)  // Si falla aquÃ­, inconsistencia

// âœ… ACEPTAR - con transaction
await session.withTransaction(async () => {
  await pedidos.insertOne(data, { session })
  await usuarios.updateOne(..., { session })
})
```

**Checklist:**
- [ ] Â¿Hay mÃºltiples operaciones DB? (INSERT + UPDATE, etc)
- [ ] Â¿Si sÃ­, Â¿usa session.withTransaction?
- [ ] Â¿Todas las operaciones incluyen { session }?

---

#### REGLA #8: Performance Medible âœ…

```typescript
// âŒ RECHAZAR - sin medir
export async function POST() {
  // ... procesamiento
  return success
}

// âœ… ACEPTAR - midiendo
export async function POST() {
  const inicio = Date.now()
  await logEvento({ ..., accion: 'INIT' })
  
  try {
    // ... procesamiento
    const duracion = Date.now() - inicio
    if (duracion > 2000) {
      await logEvento({ nivel: 'WARN', detalles: { duracion_ms } })
    }
  } catch (error) {
    await logEvento({ nivel: 'ERROR', ... })
    throw error
  }
}
```

**Checklist:**
- [ ] Â¿Es un endpoint (GET/POST)?
- [ ] Â¿Si sÃ­, Â¿mide tiempo?
- [ ] Â¿Loguea si excede threshold (e.g., 500ms)?
- [ ] Â¿Incluye timing en logs?

---

#### REGLA #9: Security Headers âœ…

**Checklist:**
- [ ] Â¿Editaste middleware.ts?
  - [ ] Si sÃ­, Â¿incluye X-Content-Type-Options?
  - [ ] Â¿Incluye X-Frame-Options?
  - [ ] Â¿Incluye CORS whitelist (no *))?
  - [ ] Â¿Incluye rate limiting?
- [ ] Â¿Editaste endpoint con query params?
  - [ ] Â¿Escapas valores para prevenir injection?

---

#### REGLA #10: NO Secrets âœ…

**Checklist:**
- [ ] Â¿Hay API keys hardcodeadas? â†’ RECHAZAR
- [ ] Â¿Hay URLs hardcodeadas? â†’ Probablemente use env
- [ ] Â¿Hay tokens en cÃ³digo? â†’ RECHAZAR
- [ ] Â¿Todos los secrets usan process.env.*? â†’ âœ…
- [ ] Â¿Hay NEXT_PUBLIC_* para valores pÃºblicos solamente?
- [ ] Â¿.env.local estÃ¡ en .gitignore?

---

### FASE 5: RED FLAGS (Auto-Rechazar)

Busca estos patrones. Si los encuentras â†’ NO commits:

```bash
# Script para detectar RED FLAGS
grep -r "const.*any" src/
grep -r "console.log.*API" src/
grep -r "process.env.GEMINI_API_KEY.*=" src/
grep -r "localStorage" src/ --exclude-dir=node_modules
grep -r "sessionStorage" src/ --exclude-dir=node_modules
grep -r "document.cookie" src/ --exclude-dir=node_modules
grep -r "\.find({}).toArray" src/  # Sin limit
grep -r "\.get(\).*" src/  # Floating promises
```

**Si encuentras algo:** Regresa y corrige.

---

### FASE 6: Comments Utility âœ…

```typescript
// âŒ RECHAZAR - inÃºtil
// Get user by ID
function getUser(id: string) { ... }

// âœ… ACEPTAR - Ãºtil
/**
 * Recupera usuario por ID de BD.
 * Usa new ObjectId() para prevenir BSON injection.
 * @param id - String representaciÃ³n de ObjectId
 * @returns Promise<User | null>
 */
function getUser(id: string): Promise<User | null> { ... }
```

**Checklist:**
- [ ] Â¿Hay comentarios?
- [ ] Â¿Si sÃ­, explican PORQUÃ‰ (no QUÃ‰)?
- [ ] Â¿Tiene JSDoc las funciones pÃºblicas?
- [ ] Â¿NingÃºn comentario "TODO" sin contexto?

---

### FASE 7: Nombrado Consistente âœ…

```typescript
// âŒ RECHAZAR
const d = new Date()
const f = (x) => x * 2
function analyzePDFAndSaveAndNotify() { ... }

// âœ… ACEPTAR
const createdAt = new Date()
const doubleValue = (x: number): number => x * 2
function analyzePDF() { ... }  // Una responsabilidad
```

**Checklist:**
- [ ] Â¿Variables tienen nombres descriptivos?
- [ ] Â¿Funciones tienen responsabilidad Ãºnica?
- [ ] Â¿Constantes en UPPER_CASE?
- [ ] Â¿Sin prefijos extraÃ±os (resp, arr, etc)?

---

## ğŸ¬ FLUJO COMPLETO PRE-COMMIT

```bash
#!/bin/bash
# scripts/pre-commit.sh

echo "ğŸ” PRE-COMMIT CHECK"
echo ""

echo "1ï¸âƒ£ Linting..."
npm run lint || exit 1

echo "2ï¸âƒ£ Type checking..."
npm run type-check || exit 1

echo "3ï¸âƒ£ Formatting..."
npm run format || exit 1

echo "4ï¸âƒ£ Unit tests..."
npm run test:unit || exit 1

echo "5ï¸âƒ£ Build check..."
npm run build || exit 1

echo ""
echo "âœ… ALL CHECKS PASSED!"
echo ""
echo "ğŸ“‹ MANUAL CHECKLIST:"
echo "  [ ] TypeScript strict (no `any`)"
echo "  [ ] Zod validation (inputs)"
echo "  [ ] AppError (error handling)"
echo "  [ ] Logging (logEvento con correlacion_id)"
echo "  [ ] No localStorage/sessionStorage"
echo "  [ ] ValidaciÃ³n cliente + servidor"
echo "  [ ] DB atÃ³micas (transactions)"
echo "  [ ] Performance medida (logs de tiempo)"
echo "  [ ] Security headers (si middleware)"
echo "  [ ] NO secrets hardcodeados"
echo "  [ ] NO RED FLAGS (any, secrets en logs, floating promises)"
echo "  [ ] Comments Ãºtiles (PORQUÃ‰, no QUÃ‰)"
echo "  [ ] Nombrado consistente"
echo ""
echo "Ejecuta: npm run pre-commit -- manual"
echo "Para confirmar manual checklist."
```

En `package.json`:
```json
{
  "scripts": {
    "pre-commit": "bash scripts/pre-commit.sh"
  }
}
```

---

## âœ… CHECKLIST FINAL (ANTES DE PUSH)

```
AUTOMATIZADO:
  â˜‘ï¸ npm run lint â†’ 0 problems
  â˜‘ï¸ npm run type-check â†’ 0 errors
  â˜‘ï¸ npm run test:unit â†’ all pass
  â˜‘ï¸ npm run build â†’ success

MANUAL (cÃ³digo review):
  â˜‘ï¸ No `any` type
  â˜‘ï¸ Zod validation para inputs
  â˜‘ï¸ AppError (no Error())
  â˜‘ï¸ logEvento con await y correlacion_id
  â˜‘ï¸ No localStorage/sessionStorage/cookies(directo)
  â˜‘ï¸ ValidaciÃ³n cliente + servidor
  â˜‘ï¸ DB transactions (si mÃºltiples ops)
  â˜‘ï¸ Tiempo medido (endpoints)
  â˜‘ï¸ Security headers (si middleware)
  â˜‘ï¸ NO secrets hardcodeados
  â˜‘ï¸ No RED FLAGS
  â˜‘ï¸ JSDoc en funciones pÃºblicas
  â˜‘ï¸ Nombres descriptivos

COMMIT:
  â˜‘ï¸ git add [archivos]
  â˜‘ï¸ git commit -m "[TYPE]: Brief description"
  â˜‘ï¸ git push origin feature/nombre
  â˜‘ï¸ Abrir PR en GitHub
```

**Si TODO estÃ¡ â˜‘ï¸:** Ready for PR! ğŸš€

---

## ğŸš¨ SI ALGO FALLA

| Fallo | AcciÃ³n |
|-------|--------|
| `npm run lint` | `npm run lint -- --fix` |
| `npm run type-check` | Revisar errores TypeScript, aÃ±adir tipos |
| `npm run test:unit` | Revisar test output, arreglar test o cÃ³digo |
| `npm run build` | Revisar errores TypeScript |
| Manual checklist fail | Revisar secciÃ³n correspondiente, corregir |

---

## ğŸ“ ESCALATION

Si algo no estÃ¡ claro:

```
1. Revisa la secciÃ³n en reglas-de-oro.md
2. Revisa ejemplo en cÃ³digo existente
3. Si aÃºn no sabes â†’ ASK IN PR COMMENT
   (Code review lead o tech lead)
```

---

## âœ¨ RESULTADO

DespuÃ©s de ejecutar todo esto:

âœ… **CÃ³digo type-safe**  
âœ… **Inputs validados**  
âœ… **Errores claros**  
âœ… **Logging completo**  
âœ… **Performance medible**  
âœ… **Seguridad garantizada**  
âœ… **Cero deuda tÃ©cnica**  

**= Production-Ready desde dÃ­a 1**

---

**Checklist:** PRE-COMMIT  
**VersiÃ³n:** 1.0  
**Vigente:** 21 de enero de 2026+  
**Responsable:** Developer (auto-enforce)
